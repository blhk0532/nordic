import{r as i,u as z,j as e}from"./app-De-pmVM3.js";import{E as B}from"./event-calendar-D93KTxTg.js";function V(){const[w,c]=i.useState(!1),[M,m]=i.useState(null),[g,b]=i.useState(null),[l,h]=i.useState(!1),[x,_]=i.useState({clients:[],services:[],locations:[],serviceUsers:[],calendars:[]}),[f,v]=i.useState([]),[y,j]=i.useState(""),{data:o,setData:n,post:A,put:q,delete:$,processing:k,reset:p}=z({service_date:"",start_time:"",end_time:"",booking_client_id:"",service_id:"",booking_location_id:"",service_user_id:"",booking_calendar_id:"",status:"booked",total_price:"",notes:"",service_note:""});i.useEffect(()=>{(async()=>{try{const[s,r,a,d,u]=await Promise.all([fetch("/api/calendar/clients"),fetch("/api/calendar/services"),fetch("/api/calendar/locations"),fetch("/api/calendar/service-users"),fetch("/api/calendar/calendars")]),[R,O,P,I,F]=await Promise.all([s.json(),r.json(),a.json(),d.json(),u.json()]);_({clients:R,services:O,locations:P,serviceUsers:I,calendars:F})}catch(s){console.error("Error loading dropdown data:",s)}})()},[]);const S=i.useCallback(t=>{const s=new Date(t.start),r=t.end?new Date(t.end):null;m({start:s,end:r,allDay:t.allDay,resourceId:t.resource?.id}),n(a=>({...a,service_date:s.toISOString().split("T")[0],start_time:s.toTimeString().slice(0,5),end_time:r?r.toTimeString().slice(0,5):"",service_user_id:t.resource?.id||""})),h(!1),c(!0)},[o,n]),N=i.useCallback(t=>{const s=t.event;b({id:s.id,title:s.title,start:s.start,end:s.end,extendedProps:s.extendedProps});const r=s.extendedProps;n(a=>({...a,service_date:r.service_date||s.start?.toISOString().split("T")[0]||"",start_time:r.start_time||s.start?.toTimeString().slice(0,5)||"",end_time:r.end_time||s.end?.toTimeString().slice(0,5)||"",booking_client_id:"",service_id:"",booking_location_id:"",service_user_id:s.getResource()?.id||"",status:r.status||"booked",total_price:r.total_price||"",notes:r.notes||"",service_note:""})),h(!0),c(!0)},[n]),E=i.useCallback(async t=>{const s=t.event,r=s.start,a=s.end,d=s.getResource()?.id;try{if(!(await fetch(`/api/calendar/bookings/${s.id}/move`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({start:r.toISOString(),end:a?a.toISOString():null,resource_id:d})})).ok)throw new Error("Failed to move booking");window.location.reload()}catch(u){console.error("Error moving booking:",u),t.revert()}},[]),C=i.useCallback(async t=>{const s=t.event,r=s.end;try{if(!(await fetch(`/api/calendar/bookings/${s.id}/resize`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({end:r.toISOString()})})).ok)throw new Error("Failed to resize booking");window.location.reload()}catch(a){console.error("Error resizing booking:",a),t.revert()}},[]),D=i.useCallback(async t=>{t.preventDefault(),v([]),j("");try{const s=l?`/api/calendar/bookings/${g?.id}`:"/api/calendar/bookings",a=await fetch(s,{method:l?"PUT":"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify(o)}),d=await a.json();if(!a.ok){if(d.errors){const u=Object.values(d.errors).flat();v(u)}else v([d.message||`Failed to ${l?"update":"create"} booking`]);return}j(d.message||`Booking ${l?"updated":"created"} successfully`),setTimeout(()=>{c(!1),p(),b(null),m(null),window.location.reload()},1500)}catch(s){console.error(`Error ${l?"updating":"creating"} booking:`,s),v(["An unexpected error occurred. Please try again."])}},[o,l,g?.id,p]),T=i.useCallback(async()=>{if(g?.id)try{if(!(await fetch(`/api/calendar/bookings/${g.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}})).ok)throw new Error("Failed to delete booking");c(!1),p(),b(null),m(null),window.location.reload()}catch(t){console.error("Error deleting booking:",t)}},[g?.id,p]);return e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"mx-auto my-10 max-w-300",editable:!0,selectable:!0,droppable:!0,nowIndicator:!0,navLinks:!0,locale:"sv",initialView:"timeGridWeek",firstDay:1,timeZone:"Europe/Stockholm",events:"/api/calendar/bookings",resources:"/calendar/resources",select:S,eventClick:N,eventDrop:E,eventResize:C,headerToolbar:{left:"",center:"",right:""},slotMinTime:"07:00:00",slotMaxTime:"20:00:00",slotDuration:"01:00:00",weekends:!0,addButton:{text:"Ny Bokning",click(){h(!1),m({start:new Date,end:new Date(Date.now()+3600*1e3),allDay:!1}),c(!0)}}}),w&&e.jsx("div",{className:"bg-opacity-50 fixed inset-0 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg sm:max-w-[550px]",children:[e.jsx("h2",{className:"mb-4 text-xl font-bold",children:l?"Redigera Bokning":"Ny Bokning"}),y&&e.jsx("div",{className:"mb-4 rounded-md bg-green-50 p-4",children:e.jsx("div",{className:"text-green-800",children:y})}),f.length>0&&e.jsx("div",{className:"mb-4 rounded-md bg-red-50 p-4",children:e.jsx("div",{className:"text-red-800",children:f.map((t,s)=>e.jsx("div",{className:"mb-1",children:t},s))})}),e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Datum"}),e.jsx("input",{type:"date",value:o.service_date,onChange:t=>n("service_date",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Status"}),e.jsxs("select",{value:o.status,onChange:t=>n("status",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",children:[e.jsx("option",{value:"booked",children:"Bokad"}),e.jsx("option",{value:"confirmed",children:"Bekräftad"}),e.jsx("option",{value:"cancelled",children:"Inställd"}),e.jsx("option",{value:"completed",children:"Genomförd"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Starttid"}),e.jsx("input",{type:"time",value:o.start_time,onChange:t=>n("start_time",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Sluttid"}),e.jsx("input",{type:"time",value:o.end_time,onChange:t=>n("end_time",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Kund"}),e.jsxs("select",{value:o.booking_client_id,onChange:t=>n("booking_client_id",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",children:[e.jsx("option",{value:"",children:"Välj kund"}),x.clients.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Tjänst"}),e.jsxs("select",{value:o.service_id,onChange:t=>n("service_id",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",children:[e.jsx("option",{value:"",children:"Välj tjänst"}),x.services.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Plats"}),e.jsxs("select",{value:o.booking_location_id,onChange:t=>n("booking_location_id",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",children:[e.jsx("option",{value:"",children:"Välj plats"}),x.locations.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Tekniker"}),e.jsxs("select",{value:o.service_user_id,onChange:t=>n("service_user_id",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",children:[e.jsx("option",{value:"",children:"Välj tekniker"}),x.serviceUsers.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Pris (SEK)"}),e.jsx("input",{type:"number",value:o.total_price,onChange:t=>n("total_price",t.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Interna anteckningar"}),e.jsx("textarea",{value:o.notes,onChange:t=>n("notes",t.target.value),rows:3,className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Service anteckningar"}),e.jsx("textarea",{value:o.service_note,onChange:t=>n("service_note",t.target.value),rows:3,className:"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"})]}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsx("div",{children:l&&e.jsx("button",{type:"button",onClick:T,className:"rounded-md bg-red-600 px-4 py-2 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:outline-none",children:"Radera"})}),e.jsxs("div",{className:"space-x-3",children:[e.jsx("button",{type:"button",onClick:()=>{c(!1),p(),b(null),m(null)},className:"rounded-md bg-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-400 focus:ring-2 focus:ring-gray-500 focus:outline-none",children:"Avbryt"}),e.jsx("button",{type:"submit",disabled:k,className:"rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:outline-none disabled:opacity-50",children:k?"Sparar...":l?"Uppdatera":"Skapa"})]})]})]})]})})]})}export{V as E};
